<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>æ¾æ¹–é¦¬å…¬æ©Ÿå ´èˆªç­å³æ™‚ç›£æ§</title>

<style>
/* ğŸŒŠ æ¾æ¹–é¢¨æƒ…é…è‰²ä¸»é¡Œ */
:root {
  --penghu-ocean: #0891b2;        /* ç¢§æµ·è— */
  --penghu-sunset: #f97316;       /* å¤•é™½æ©˜ */
  --penghu-basalt: #1e293b;       /* ç„æ­¦å²©æ·±ç° */
  --penghu-sunrise: #fbbf24;      /* æ—¥å‡ºé‡‘é»ƒ */
  --penghu-coral: #fb7185;        /* çŠç‘šç²‰ */
  --penghu-cactus: #10b981;       /* ä»™äººæŒç¶  */
  --penghu-sky: #38bdf8;          /* å¤©ç©ºè— */
  --penghu-sand: #fef3c7;         /* æ²™ç˜ç±³ */
  --penghu-wave: #06b6d4;         /* æµ·æµªé’ */
  --footer-height: 56px;
}

html, body {
  height: 100%;
}

body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  background: linear-gradient(135deg, var(--penghu-sand) 0%, #f0f9ff 100%);
  min-height: 100vh;
  min-height: 100svh;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  padding-bottom: var(--footer-height);
}

header {
  background: linear-gradient(135deg, var(--penghu-ocean) 0%, var(--penghu-basalt) 100%);
  color: white;
  padding: calc(14px + env(safe-area-inset-top)) calc(18px + env(safe-area-inset-right)) 14px calc(18px + env(safe-area-inset-left));
  display: flex;
  justify-content: space-between;
  align-items: center;
  gap: 12px;
  box-shadow: 0 4px 12px rgba(8, 145, 178, 0.2);
}

.header-actions {
  display: flex;
  align-items: center;
  gap: 12px;
}

.home-link {
  color: #fff;
  text-decoration: none;
  font-size: 13px;
  border-radius: 999px;
  padding: 4px 10px;
  border: 1px solid rgba(255, 255, 255, 0.35);
  background: rgba(255, 255, 255, 0.12);
  transition: background 0.2s ease;
}

.home-link:hover {
  background: rgba(255, 255, 255, 0.22);
}

#status {
  font-size: 13px;
  opacity: .9;
  white-space: nowrap;
}

@media (max-width: 900px) {
  #status .status-last-updated-label {
    display: none;
  }

  .home-link {
    display: none;
  }
}

#container {
  display: flex;
  flex: 1 1 auto;
  min-height: 0;
}

body.map-disabled #right {
  display: none;
}

body.map-disabled #left {
  width: 100%;
}

/* ===== æœå°‹æ¡† ===== */
#searchBox {
  padding: 12px;
  background: linear-gradient(to right, rgba(251, 113, 133, 0.05), rgba(56, 189, 248, 0.05));
  border-bottom: 3px solid var(--penghu-wave);
  position: sticky;
  top: 0;
  z-index: 10;
  box-shadow: 0 2px 8px rgba(8, 145, 178, 0.1);
}

#searchContainer {
  position: relative;
  display: flex;
  align-items: stretch;
  gap: 8px;
  flex-wrap: wrap;
}

@media (min-width: 901px) {
  #searchContainer {
    flex-wrap: nowrap;
  }
}

#searchIcon {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  width: 18px;
  height: 18px;
  color: #64748b;
  pointer-events: none;
  z-index: 1;
}

#searchInputWrapper {
  position: relative;
  flex: 1;
  min-width: 0;
}

#searchInput {
  width: 100%;
  padding: 10px 38px 10px 40px;
  font-size: 15px;
  border: 2px solid var(--penghu-sky);
  border-radius: 8px;
  box-sizing: border-box;
  transition: all 0.3s ease;
  background: white;
}

#originFilter {
  padding: 10px 12px;
  font-size: 15px;
  border: 2px solid var(--penghu-cactus);
  border-radius: 8px;
  box-sizing: border-box;
  transition: all 0.3s ease;
  background: white;
  cursor: pointer;
  color: #1e293b;
  font-weight: 500;
  min-width: 120px;
}

#originFilter:focus {
  outline: none;
  border-color: var(--penghu-ocean);
  box-shadow: 0 0 0 3px rgba(8, 145, 178, 0.1);
}

#originFilter.has-value {
  border-color: var(--penghu-ocean);
  background: linear-gradient(to right, #d1fae5, #ecfeff);
}

@media (max-width: 900px) {
  #searchInputWrapper {
    flex: 1 1 100%;
  }

  #originFilter {
    flex: 1 1 100%;
    min-width: 0;
  }
}

#searchInput:focus {
  outline: none;
  border-color: var(--penghu-sunset);
  box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.1);
}

#searchInput:focus + #searchIcon {
  color: var(--penghu-sunset);
}

#searchInput::placeholder {
  color: #94a3b8;
}

#searchInput.has-value {
  border-color: var(--penghu-ocean);
  background: linear-gradient(to right, #ecfeff, #fef3c7);
}

#searchInput.has-value ~ #searchIcon {
  color: var(--penghu-ocean);
}

#searchHint {
  font-size: 12px;
  color: var(--penghu-ocean);
  margin-top: 6px;
  display: none;
  align-items: center;
  gap: 4px;
  background: linear-gradient(to right, rgba(8, 145, 178, 0.1), transparent);
  padding: 4px 8px;
  border-radius: 6px;
}

#searchHint.visible {
  display: flex;
}

#searchHint svg {
  width: 14px;
  height: 14px;
  flex-shrink: 0;
}

/* ===== å·¦å´åˆ—è¡¨ ===== */
#left {
  width: 50%;
  overflow: hidden;
  padding: 0;
  box-sizing: border-box;
  display: flex;
  flex-direction: column;
}

#leftContent {
  flex: 1;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
  overscroll-behavior: contain;
  padding: 10px;
  padding-bottom: calc(10px + var(--footer-height));
  position: relative;
}

#flightTableDesktop {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
  background: #fff;
  box-shadow: 0 4px 12px rgba(8, 145, 178, 0.08);
  border-radius: 8px;
  overflow: hidden;
}

#flightTableDesktop th,
#flightTableDesktop td {
  padding: 6px;
  border-bottom: 1px solid #e0f2fe;
  text-align: center;
  white-space: nowrap;
}

#flightTableDesktop th {
  background: linear-gradient(135deg, var(--penghu-ocean), var(--penghu-wave));
  color: white;
  position: sticky;
  top: 0;
  z-index: 5;
  font-weight: 600;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.status-Arrived {
  background: linear-gradient(135deg, var(--penghu-cactus), #059669);
  color: #fff;
  font-weight: 600;
  border-radius: 4px;
  padding: 4px 8px;
  box-shadow: 0 2px 4px rgba(16, 185, 129, 0.3);
}

.status-OnTime {
  background: linear-gradient(135deg, var(--penghu-ocean), var(--penghu-sky));
  color: #fff;
  font-weight: 600;
  border-radius: 4px;
  padding: 4px 8px;
  box-shadow: 0 2px 4px rgba(8, 145, 178, 0.3);
}

.status-Delayed {
  background: linear-gradient(135deg, var(--penghu-sunset), #ea580c);
  color: #fff;
  font-weight: 600;
  border-radius: 4px;
  padding: 4px 8px;
  box-shadow: 0 2px 4px rgba(249, 115, 22, 0.3);
}

.status-Waiting {
  background: linear-gradient(135deg, var(--penghu-sand), #fde68a);
  color: #78716c;
  font-weight: 600;
  border-radius: 4px;
  padding: 4px 8px;
}

.status-Cancelled {
  background: linear-gradient(135deg, var(--penghu-coral), #f43f5e);
  color: #fff;
  font-weight: 600;
  border-radius: 4px;
  padding: 4px 8px;
  box-shadow: 0 2px 4px rgba(251, 113, 133, 0.3);
}

/* æœªåˆ°é”èˆªç­é«˜äº® */
.upcoming-flight {
  background-color: rgba(251, 191, 36, 0.1);
  border-left: 3px solid var(--penghu-sunrise);
}

.upcoming-flight-card {
  border-left: 4px solid var(--penghu-sunrise);
  box-shadow: 0 4px 16px rgba(251, 191, 36, 0.3);
}

/* é è¨­éš±è—å¡ç‰‡å®¹å™¨ï¼ˆæ¡Œé¢ç‰ˆï¼‰ */
#cardContainer {
  display: none;
}

/* å¡ç‰‡æ¨£å¼ï¼ˆé å…ˆå®šç¾©ï¼Œé¿å… FOUCï¼‰ */
.card {
  background: linear-gradient(135deg, white, #fafafa);
  margin: 10px;
  padding: 12px;
  border-radius: 12px;
  box-shadow: 0 4px 12px rgba(8, 145, 178, 0.15);
  display: none;
  border-left: 4px solid var(--penghu-ocean);
  transition: all 0.3s ease;
}

.card:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(8, 145, 178, 0.25);
  border-left-color: var(--penghu-sunset);
}

.card-title {
  font-weight: 800;
  margin-bottom: 6px;
  font-size: 16px;
  color: var(--penghu-basalt);
  background: linear-gradient(135deg, var(--penghu-ocean), var(--penghu-sunset));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.card-row {
  font-size: 14px;
  margin: 2px 0;
  color: #475569;
}

.card-badge {
  display: inline-block;
  margin-top: 8px;
  padding: 4px 8px;
  border-radius: 6px;
  font-weight: 700;
}

/* ===== åœ°åœ– ===== */
#right {
  width: 50%;
  box-sizing: border-box;
}

#map {
  height: 100%;
}

/* ===== æ‰‹æ©Ÿæ¨¡å¼ ===== */
@media (max-width: 900px) {
  #right {
    display: none !important;
  }

  #left {
    width: 100% !important;
    padding: 0 !important;
  }

  /* éš±è—æˆ‘å€‘çš„èˆªç­è¡¨æ ¼ */
  #flightTableDesktop {
    display: none !important;
  }

  /* é¡¯ç¤ºå¡ç‰‡å®¹å™¨å’Œå¡ç‰‡ */
  #cardContainer {
    display: block !important;
  }

  .card {
    display: block !important;
  }
}

footer {
  position: fixed;
  left: 0;
  right: 0;
  bottom: 0;
  height: var(--footer-height);
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 0 16px calc(0px + env(safe-area-inset-bottom));
  text-align: center;
  font-size: 13px;
  color: #0f172a;
  background: linear-gradient(90deg, rgba(255, 251, 235, 0.98), rgba(240, 249, 255, 0.98));
  border-top: 1px solid rgba(8, 145, 178, 0.15);
  box-shadow: 0 -10px 22px rgba(8, 145, 178, 0.16);
}

footer a {
  color: var(--penghu-ocean);
  text-decoration: none;
  font-weight: 700;
}

footer a:hover {
  text-decoration: underline;
}

@media (max-width: 720px) {
  :root {
    --footer-height: 72px;
  }

  footer {
    font-size: 12px;
    padding: 0 16px calc(4px + env(safe-area-inset-bottom));
    text-align: center;
  }
}
</style>
</head>

<body>

<header>
  <strong>âœˆ æ¾æ¹–é¦¬å…¬æ©Ÿå ´èˆªç­å³æ™‚ç›£æ§</strong>
  <div class="header-actions">
    <a class="home-link" href="../../index.html">æ©Ÿå ´ç¸½è¦½</a>
    <span id="status">è®€å–ä¸­â€¦</span>
  </div>
</header>

<div id="container">
  <div id="left">
    <div id="searchBox">
      <div id="searchContainer">
        <div id="searchInputWrapper">
          <input
            type="search"
            id="searchInput"
            placeholder="æœå°‹èˆªç©ºã€èˆªç­æˆ–æ©Ÿå‹..."
            autocomplete="off"
          >
          <svg id="searchIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
            <path fill-rule="evenodd" d="M9 3.5a5.5 5.5 0 100 11 5.5 5.5 0 000-11zM2 9a7 7 0 1112.452 4.391l3.328 3.329a.75.75 0 11-1.06 1.06l-3.329-3.328A7 7 0 012 9z" clip-rule="evenodd" />
          </svg>
        </div>
        <select id="originFilter">
          <option value="">å…¨éƒ¨ä¾†æºåœ°</option>
        </select>
      </div>
      <div id="searchHint">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
          <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a.75.75 0 000 1.5h.253a.25.25 0 01.244.304l-.459 2.066A1.75 1.75 0 0010.747 15H11a.75.75 0 000-1.5h-.253a.25.25 0 01-.244-.304l.459-2.066A1.75 1.75 0 009.253 9H9z" clip-rule="evenodd" />
        </svg>
        <span id="searchHintText">æ­£åœ¨ä½¿ç”¨æœå°‹éæ¿¾,åƒ…é¡¯ç¤ºç¬¦åˆçš„èˆªç­</span>
      </div>
    </div>

    <div id="leftContent">
      <table id="flightTableDesktop">
        <thead>
          <tr>
            <th>èˆªç©º</th>
            <th>èˆªç­</th>
            <th>ä¾†è‡ª</th>
            <th>æ©Ÿå‹</th>
            <th>è¡¨å®šèµ·é£›</th>
            <th>å¯¦éš›èµ·é£›</th>
            <th>è¡¨å®šåˆ°é”</th>
            <th>é ä¼°/å¯¦éš›åˆ°é”</th>
            <th>å‚™è¨»</th>
          </tr>
        </thead>
        <tbody id="flightTable"></tbody>
      </table>

      <div id="cardContainer"></div>
    </div>
  </div>

  <div id="right">
    <div id="map"></div>
  </div>
</div>

<footer>æœ¬å·¥å…·ç”± <a href="https://www.facebook.com/will.fans/" target="_blank" rel="noopener noreferrer">Will ä¿å“¥çš„æŠ€è¡“äº¤æµä¸­å¿ƒ</a> è¨­è¨ˆã€é–‹ç™¼èˆ‡ç¶­è­·</footer>

<script>
// @ts-check
let map;
let refreshHandle = null;
let allFlights = []; // å„²å­˜æ‰€æœ‰èˆªç­è³‡æ–™
let searchTerm = ''; // ç›®å‰æœå°‹é—œéµå­—
let originFilter = ''; // ç›®å‰ä¾†æºåœ°ç¯©é¸
const isMobile = window.matchMedia('(max-width: 900px)').matches;
const SEARCH_STORAGE_KEY = 'flight_search_term'; // localStorage key
const ORIGIN_STORAGE_KEY = 'flight_origin_filter'; // localStorage key for origin filter
const ENABLE_MAP = false; // éœ€è¦é¡¯ç¤ºåœ°åœ–æ™‚æ”¹æˆ true
const API_URL = 'https://duotifylearnfiles.blob.core.windows.net/flight-data/data-penghu.jsonp';
const JSONP_CALLBACK_NAME = '__penghuFlightDataCallback';
const JSONP_TIMEOUT_MS = 8000;

if (!ENABLE_MAP) {
  document.body.classList.add('map-disabled');
}

// åªåœ¨æ¡Œé¢ç‰ˆå‹•æ…‹è¼‰å…¥ Leaflet
function loadLeaflet() {
  return new Promise((resolve, reject) => {
    if (isMobile) {
      resolve();
      return;
    }

    // è¼‰å…¥ CSS
    const link = document.createElement('link');
    link.rel = 'stylesheet';
    link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
    document.head.appendChild(link);

    // è¼‰å…¥ JS
    const script = document.createElement('script');
    script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
    script.onload = resolve;
    script.onerror = reject;
    document.body.appendChild(script);
  });
}

function initMap() {
  if (isMobile || typeof L === 'undefined') return;

  map = L.map('map').setView([23.57, 119.63], 9);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap'
  }).addTo(map);
}

/**
 * æœå°‹éæ¿¾é‚è¼¯
 * @param {Array} flights
 * @param {string} term - æœå°‹é—œéµå­—
 * @param {string} origin - ä¾†æºåœ°ç¯©é¸
 * @returns {Array}
 */
function filterFlights(flights, term, origin) {
  let result = flights;

  // å…ˆç¯©é¸ä¾†æºåœ°
  if (origin && origin.trim() !== '') {
    result = result.filter(f => getOriginText(f) === origin);
  }

  // å†å¥—ç”¨æœå°‹é—œéµå­—
  if (term && term.trim() !== '') {
    const lowerTerm = term.toLowerCase().trim();
    result = result.filter(f => {
      const air = safeText(f.Air).toLowerCase();
      const flightNo = safeText(f.FlightNo).toLowerCase();
      const aircraft = safeText(f.Aircraft).toLowerCase();

      return air.includes(lowerTerm) ||
             flightNo.includes(lowerTerm) ||
             aircraft.includes(lowerTerm);
    });
  }

  return result;
}

/**
 * UI Render: table + cards
 * @param {Array} flights
 */
function renderFlights(flights) {
  const tbody = document.getElementById('flightTable');
  const cardBox = document.getElementById('cardContainer');

  tbody.innerHTML = '';
  cardBox.innerHTML = '';

  const now = new Date();
  let firstUpcomingRow = null;
  let firstUpcomingCard = null;

  flights.forEach(f => {
    const statusClass = f.StatusClass ? `status-${f.StatusClass}` : '';

    // åˆ¤æ–·æ˜¯å¦ç‚ºæœªåˆ°é”èˆªç­ï¼ˆåˆ°é”æ™‚é–“åœ¨ç•¶å‰æ™‚é–“ä¹‹å¾Œï¼‰
    const isUpcoming = isUpcomingFlight(f, now);

    // --- Table row ---
    const tr = document.createElement('tr');
    if (isUpcoming && !firstUpcomingRow) {
      tr.className = 'upcoming-flight';
      firstUpcomingRow = tr;
    }
    tr.innerHTML = `
      <td>${safeText(f.Air)}</td>
      <td>${safeText(f.FlightNo)}</td>
      <td>${safeText(f.Origin)}</td>
      <td>${safeText(f.Aircraft || f.STs)}</td>
      <td>${safeText(f.STs)}</td>
      <td>${safeText(f.ATs)}</td>
      <td>${safeText(f.STe)}</td>
      <td>${safeText(f.ATe)}</td>
      <td class="${statusClass}">${safeText(f.Remark)}</td>
    `;
    tbody.appendChild(tr);

    // --- Mobile card ---
    const card = document.createElement('div');
    card.className = 'card';
    if (isUpcoming && !firstUpcomingCard) {
      card.classList.add('upcoming-flight-card');
      firstUpcomingCard = card;
    }
    card.innerHTML = `
      <div class="card-title">${safeText(f.Air)} ${safeText(f.FlightNo)}</div>
      <div class="card-row">ä¾†è‡ªï¼š${safeText(f.Origin)}</div>
      <div class="card-row">æ©Ÿå‹ï¼š${safeText(f.Aircraft || f.STs)}</div>
      <div class="card-row">èµ·é£›ï¼šè¡¨å®š ${safeText(f.STs)}ï¼ˆå¯¦éš›ï¼š${safeText(f.ATs) || '---'}ï¼‰</div>
      <div class="card-row">åˆ°é”ï¼šè¡¨å®š ${safeText(f.STe)}ï¼ˆé ä¼°/å¯¦éš›ï¼š${safeText(f.ATe)}ï¼‰</div>
      <span class="card-badge ${statusClass}">${safeText(f.Remark)}</span>
    `;
    cardBox.appendChild(card);
  });

  // è‡ªå‹•æ»¾å‹•åˆ°ç¬¬ä¸€ç­†æœªåˆ°é”èˆªç­
  scrollToUpcoming(firstUpcomingRow, firstUpcomingCard);
}

/**
 * æ›´æ–°å³ä¸Šè§’ç‹€æ…‹é¡¯ç¤ºï¼ˆæœ€å¾Œæ›´æ–°æ™‚é–“ï¼‰
 * - æ¡Œé¢ç‰ˆï¼šé¡¯ç¤ºã€Œæœ€å¾Œæ›´æ–°ï¼šHH:MM:SSã€
 * - è¡Œå‹•ç‰ˆï¼šé€é CSS éš±è—ã€Œæœ€å¾Œæ›´æ–°ï¼šã€ï¼Œåƒ…é¡¯ç¤ºæ™‚é–“
 * @param {number|string|Date} timestamp
 */
function setStatusLastUpdated(timestamp) {
  const statusEl = document.getElementById('status');
  if (!statusEl) return;

  let labelEl = statusEl.querySelector('.status-last-updated-label');
  let timeEl = statusEl.querySelector('.status-last-updated-time');

  if (!labelEl || !timeEl) {
    statusEl.textContent = '';

    labelEl = document.createElement('span');
    labelEl.className = 'status-last-updated-label';
    labelEl.textContent = 'æœ€å¾Œæ›´æ–°ï¼š';

    timeEl = document.createElement('span');
    timeEl.className = 'status-last-updated-time';

    statusEl.appendChild(labelEl);
    statusEl.appendChild(timeEl);
  }

  timeEl.textContent = new Date(timestamp).toLocaleTimeString('zh-TW');
}

/**
 * æ­¤å‡½å¼è² è²¬ã€Œåƒå¾Œç«¯å›å‚³ã€â†’ã€Œè½‰æˆ flights é™£åˆ—ã€â†’ã€Œæ¸²æŸ“ã€
 */
function renderDataWrapper(res) {
  // å¾Œç«¯è³‡æ–™çµæ§‹ï¼š{ timestamp, data: { status, data: [...] } }
  const flights = res?.data?.data;

  if (!res || !res.timestamp || !Array.isArray(flights)) {
    console.error('[renderDataWrapper] è³‡æ–™æ ¼å¼éŒ¯èª¤', res);
    document.getElementById('status').innerText = 'è³‡æ–™æ ¼å¼éŒ¯èª¤';
    return;
  }

  setStatusLastUpdated(res.timestamp);

  allFlights = flights; // å„²å­˜æ‰€æœ‰èˆªç­è³‡æ–™
  updateOriginFilter(); // æ›´æ–°ä¾†æºåœ°ç¯©é¸é¸é …
  applySearchAndRender(); // å¥—ç”¨æœå°‹ä¸¦æ¸²æŸ“
}

async function loadData() {
  try {
    const result = await loadJsonp(API_URL, {
      timeoutMs: JSONP_TIMEOUT_MS
    });

    if (result.status === 'error') {
      console.error('[loadData] API éŒ¯èª¤', result.message);
      document.getElementById('status').innerText = 'API éŒ¯èª¤: ' + result.message;
      return;
    }

    renderDataWrapper(result);
  } catch (err) {
    const errorDetail = err instanceof Error ? err.stack || err.message : String(err);
    console.error('[loadData] è®€å–å¤±æ•—', errorDetail);
    document.getElementById('status').innerText = 'è³‡æ–™è®€å–å¤±æ•—';
  }
}

/**
 * åˆ¤æ–·æ˜¯å¦ç‚ºæœªåˆ°é”èˆªç­
 * @param {Object} flight - èˆªç­è³‡æ–™
 * @param {Date} now - ç•¶å‰æ™‚é–“
 * @returns {boolean}
 */
function isUpcomingFlight(flight, now) {
  // å–å¾—åˆ°é”æ™‚é–“å­—ä¸² (æ ¼å¼ï¼šHH:MM)
  const arrivalTimeStr = safeText(flight.ATe).trim();
  if (!arrivalTimeStr || arrivalTimeStr === '') return false;

  // è§£æåˆ°é”æ™‚é–“
  const arrivalParts = arrivalTimeStr.split(':');
  if (arrivalParts.length !== 2) return false;

  const arrivalHour = parseInt(arrivalParts[0], 10);
  const arrivalMinute = parseInt(arrivalParts[1], 10);

  if (isNaN(arrivalHour) || isNaN(arrivalMinute)) return false;

  // å»ºç«‹ä»Šå¤©çš„åˆ°é”æ™‚é–“
  const arrivalTime = new Date();
  arrivalTime.setHours(arrivalHour, arrivalMinute, 0, 0);

  // æ¯”è¼ƒæ™‚é–“ï¼ˆåˆ°é”æ™‚é–“åœ¨ç•¶å‰æ™‚é–“ä¹‹å¾Œï¼‰
  return arrivalTime > now;
}

/**
 * è‡ªå‹•æ»¾å‹•åˆ°ç¬¬ä¸€ç­†æœªåˆ°é”èˆªç­
 * @param {HTMLElement} row - æ¡Œé¢ç‰ˆè¡¨æ ¼åˆ—
 * @param {HTMLElement} card - è¡Œå‹•ç‰ˆå¡ç‰‡
 */
function scrollToUpcoming(row, card) {
  setTimeout(() => {
    const leftContent = document.getElementById('leftContent');
    if (isMobile && card && leftContent) {
      // è¡Œå‹•ç‰ˆï¼šåªæ»¾å‹•å…§å®¹å®¹å™¨ï¼Œé¿å… iOS scrollIntoView é€ æˆæ•´é ä¸Šç§»
      const top =
        card.getBoundingClientRect().top -
        leftContent.getBoundingClientRect().top +
        leftContent.scrollTop;
      leftContent.scrollTo({ top: Math.max(0, top - 10), behavior: 'smooth' });
    } else if (!isMobile && row) {
      // æ¡Œé¢ç‰ˆï¼šæ»¾å‹•åˆ°è¡¨æ ¼åˆ—ï¼ˆè€ƒæ…®å›ºå®šæ¨™é¡Œçš„é«˜åº¦ï¼‰
      const thead = document.querySelector('#flightTableDesktop thead');
      const theadHeight = thead ? thead.offsetHeight : 0;

      // è¨ˆç®—æ»¾å‹•ä½ç½®ï¼ˆrow ç›¸å°æ–¼ leftContent çš„ä½ç½® - æ¨™é¡Œé«˜åº¦ï¼‰
      const rowTop = row.offsetTop - theadHeight - 10; // æ¸›å» 10px ä½œç‚ºç·©è¡
      if (leftContent) leftContent.scrollTo({ top: rowTop, behavior: 'smooth' });
    }
  }, 300); // å»¶é² 300ms ç¢ºä¿æ¸²æŸ“å®Œæˆ
}

/**
 * å¥—ç”¨æœå°‹ä¸¦é‡æ–°æ¸²æŸ“
 */
function applySearchAndRender() {
  const filtered = filterFlights(allFlights, searchTerm, originFilter);
  renderFlights(filtered);
}

/**
 * ä¾ç­†ç•«æ’åºåŸå¸‚åç¨±
 * @param {Array<string>} cities
 * @returns {Array<string>}
 */
function sortByStroke(cities) {
  // ä¾†æºåœ°æ’åºè¦å‰‡ï¼šä¾å°ç£ã€Œç”±åŒ—åˆ°å—ã€çš„åœ°ç†é †åº
  // - å„ªå…ˆä»¥ IATA ä¸‰ç¢¼ï¼ˆå­—ä¸²å°¾ç«¯ï¼Œä¾‹å¦‚ï¼šè‡ºåŒ—TSAï¼‰åˆ¤æ–·
  // - è‹¥ç„¡ IATAï¼Œå‰‡ä»¥å¸¸è¦‹åŸå¸‚åç¨±å‰ç¶´åˆ¤æ–·
  // - ä¸åœ¨æ¸…å–®å…§è€… fallback å› zh-Hant-TW å­—å…¸åº
  const iataRank = new Map([
    ['TSA', 10], // è‡ºåŒ—ï¼ˆæ¾å±±ï¼‰
    ['RMQ', 20], // è‡ºä¸­
    ['CYI', 30], // å˜‰ç¾©
    ['TNN', 40], // è‡ºå—
    ['KHH', 50], // é«˜é›„
    ['CMJ', 60], // ä¸ƒç¾ï¼ˆæ¾æ¹–ï¼‰
  ]);

  const prefixRank = new Map([
    ['è‡ºåŒ—', 10],
    ['å°åŒ—', 10],
    ['è‡ºä¸­', 20],
    ['å°ä¸­', 20],
    ['å˜‰ç¾©', 30],
    ['è‡ºå—', 40],
    ['å°å—', 40],
    ['é«˜é›„', 50],
    ['ä¸ƒç¾', 60],
  ]);

  /**
   * @param {string} s
   * @returns {number}
   */
  function getGeoRank(s) {
    const text = safeText(s).trim();
    if (!text) return Number.POSITIVE_INFINITY;

    const m = text.match(/([A-Z]{3})$/);
    if (m) {
      const code = m[1];
      const r = iataRank.get(code);
      if (typeof r === 'number') return r;
    }

    for (const [prefix, r] of prefixRank.entries()) {
      if (text.startsWith(prefix)) return r;
    }

    return Number.POSITIVE_INFINITY;
  }

  return cities.sort((a, b) => {
    const ra = getGeoRank(a);
    const rb = getGeoRank(b);
    if (ra !== rb) return ra - rb;
    return String(a).localeCompare(String(b), 'zh-Hant-TW');
  });
}

/**
 * æ›´æ–°ä¾†æºåœ°ä¸‹æ‹‰é¸å–®é¸é …
 */
function updateOriginFilter() {
  const originSelect = document.getElementById('originFilter');
  if (!originSelect) return;

  // å–å¾—æ‰€æœ‰ä¸é‡è¤‡çš„ä¾†æºåœ°
  const origins = [...new Set(allFlights.map(f => getOriginText(f)).filter(o => o !== ''))];

  // ä¾ç­†ç•«æ’åº
  const sortedOrigins = sortByStroke(origins);

  // æ¸…ç©ºä¸¦é‡å»ºé¸é …
  originSelect.innerHTML = '<option value="">å…¨éƒ¨ä¾†æºåœ°</option>';
  sortedOrigins.forEach(origin => {
    const option = document.createElement('option');
    option.value = origin;
    option.textContent = origin;
    originSelect.appendChild(option);
  });

  // æ¢å¾©ä¹‹å‰å„²å­˜çš„é¸æ“‡ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
  if (originFilter) {
    originSelect.value = originFilter;
    updateOriginFilterUI(true);
  }
}

/**
 * åˆå§‹åŒ–æœå°‹åŠŸèƒ½
 */
function initSearch() {
  const searchInput = document.getElementById('searchInput');
  const originSelect = document.getElementById('originFilter');

  // å¾ localStorage è®€å–ä¸Šæ¬¡çš„æœå°‹æ¢ä»¶
  const savedSearch = localStorage.getItem(SEARCH_STORAGE_KEY);
  if (savedSearch) {
    searchTerm = savedSearch;
    searchInput.value = savedSearch;
  }

  // å¾ localStorage è®€å–ä¸Šæ¬¡çš„ä¾†æºåœ°ç¯©é¸ï¼ˆå¯¦éš›é¸é …æœƒåœ¨è³‡æ–™è¼‰å…¥å¾Œç”± updateOriginFilter æ¢å¾©ï¼‰
  const savedOrigin = localStorage.getItem(ORIGIN_STORAGE_KEY);
  if (savedOrigin) {
    originFilter = savedOrigin;
  }

  // åˆå§‹ UIï¼ˆæç¤ºéœ€åŒæ™‚è€ƒæ…®æœå°‹èˆ‡ç¯©é¸ï¼‰
  updateSearchUI(!!searchTerm.trim());
  updateOriginFilterUI(!!originFilter.trim());

  // ç›£è½ä¾†æºåœ°ç¯©é¸è®Šæ›´
  originSelect.addEventListener('change', (e) => {
    originFilter = e.target.value;

    // å„²å­˜åˆ° localStorage
    if (originFilter.trim()) {
      localStorage.setItem(ORIGIN_STORAGE_KEY, originFilter);
    } else {
      localStorage.removeItem(ORIGIN_STORAGE_KEY);
    }

    updateOriginFilterUI(!!originFilter.trim());
    applySearchAndRender();
  });

  const handleSearchChange = () => {
    searchTerm = searchInput.value;

    // å„²å­˜åˆ° localStorage
    if (searchTerm.trim()) {
      localStorage.setItem(SEARCH_STORAGE_KEY, searchTerm);
    } else {
      localStorage.removeItem(SEARCH_STORAGE_KEY);
    }

    updateSearchUI(!!searchTerm.trim());
    applySearchAndRender();
  };

  // ç›£è½è¼¸å…¥äº‹ä»¶ï¼ˆtype="search" çš„åŸç”Ÿæ¸…é™¤æŒ‰éˆ•å¯èƒ½åªè§¸ç™¼ search eventï¼‰
  searchInput.addEventListener('input', handleSearchChange);
  searchInput.addEventListener('search', handleSearchChange);

  // éµç›¤äº‹ä»¶ï¼šæŒ‰ Esc æ¸…ç©ºæœå°‹
  searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
      searchTerm = '';
      searchInput.value = '';
      originFilter = '';
      originSelect.value = '';
      localStorage.removeItem(SEARCH_STORAGE_KEY);
      localStorage.removeItem(ORIGIN_STORAGE_KEY);
      updateSearchUI(false);
      updateOriginFilterUI(false);
      applySearchAndRender();
      searchInput.blur(); // ç§»é™¤ç„¦é»
    }
  });
}

/**
 * æ›´æ–°æœå°‹ UI ç‹€æ…‹
 * @param {boolean} hasSearch - æ˜¯å¦æœ‰æœå°‹æ¢ä»¶
 */
function updateSearchUI(hasSearch) {
  const searchInput = document.getElementById('searchInput');
  const searchHint = document.getElementById('searchHint');
  const hasFilter = !!originFilter.trim();

  if (hasSearch || hasFilter) {
    searchInput.classList.add('has-value');
    searchHint.classList.add('visible');
  } else {
    searchInput.classList.remove('has-value');
    searchHint.classList.remove('visible');
  }
}

/**
 * æ›´æ–°ä¾†æºåœ°ç¯©é¸ UI ç‹€æ…‹
 * @param {boolean} hasFilter - æ˜¯å¦æœ‰ç¯©é¸æ¢ä»¶
 */
function updateOriginFilterUI(hasFilter) {
  const originSelect = document.getElementById('originFilter');

  if (hasFilter) {
    originSelect.classList.add('has-value');
  } else {
    originSelect.classList.remove('has-value');
  }

  // åŒæ™‚æ›´æ–°æœå°‹ UIï¼ˆæç¤ºéœ€è¦åŒæ™‚è€ƒæ…®æœå°‹å’Œç¯©é¸ï¼‰
  updateSearchUI(!!searchTerm.trim());
}

function safeText(v) {
  if (v === null || v === undefined) return '';
  return String(v);
}

/**
 * JSONP è¼‰å…¥å·¥å…·
 * @param {string} url
 * @param {{ timeoutMs?: number }} [options]
 * @returns {Promise<any>}
 */
function loadJsonp(url, options = {}) {
  const timeoutMs = typeof options.timeoutMs === 'number' ? options.timeoutMs : 8000;
  const callbackName = JSONP_CALLBACK_NAME;

  return new Promise((resolve, reject) => {
    const script = document.createElement('script');
    const separator = url.includes('?') ? '&' : '?';
    let settled = false;
    let timeoutId;

    /**
     * @param {any} data
     */
    function done(data) {
      if (settled) return;
      settled = true;
      if (timeoutId) clearTimeout(timeoutId);
      cleanup();
      resolve(data);
    }

    function cleanup() {
      if (script.parentNode) {
        script.parentNode.removeChild(script);
      }
      try {
        delete window[callbackName];
      } catch (err) {
        window[callbackName] = undefined;
      }
    }

    window[callbackName] = done;
    script.src = `${url}${separator}t=${Date.now()}`;
    script.onerror = () => {
      if (settled) return;
      settled = true;
      if (timeoutId) clearTimeout(timeoutId);
      cleanup();
      reject(new Error('JSONP è¼‰å…¥å¤±æ•—'));
    };

    if (timeoutMs > 0) {
      timeoutId = setTimeout(() => {
        if (settled) return;
        settled = true;
        cleanup();
        reject(new Error('JSONP é€¾æ™‚'));
      }, timeoutMs);
    }

    document.head.appendChild(script);
  });
}

/**
 * å–å¾—ã€Œä¾†è‡ªã€é¡¯ç¤ºæ–‡å­—ï¼ˆç›¸å®¹ä¸åŒè³‡æ–™æ¬„ä½ï¼‰
 * docs/data.json ä½¿ç”¨ Originï¼Œä¾‹å¦‚ï¼š"è‡ºå—TNN"
 */
function getOriginText(flight) {
  return safeText(flight?.Origin || flight?.From).trim();
}

window.onload = async () => {
  // åˆå§‹åŒ–æœå°‹åŠŸèƒ½ï¼ˆå¿…é ˆåœ¨è¼‰å…¥è³‡æ–™å‰ï¼‰
  initSearch();

  // å…ˆè¼‰å…¥è³‡æ–™
  loadData();

  // åªåœ¨æ¡Œé¢ç‰ˆè¼‰å…¥åœ°åœ–
  if (ENABLE_MAP && !isMobile) {
    try {
      await loadLeaflet();
      initMap();
    } catch (err) {
      console.error('[Leaflet] è¼‰å…¥å¤±æ•—', err);
    }

    // æ¡Œé¢ç‰ˆé è¨­é¸ä¸­æœå°‹æ¡†
    setTimeout(() => {
      document.getElementById('searchInput').focus();
    }, 100);
  }

  if (refreshHandle) clearInterval(refreshHandle);
  refreshHandle = setInterval(loadData, 60000);
};
</script>

</body>
</html>
